import { TestingModule } from '@nestjs/testing';
import { Exploit } from '@prisma/client';
import { expect } from 'chai';
import { assert } from 'console';
import { CreateExploitDto } from '../../src/exploit/dto';
import { ExploitService } from '../../src/exploit/exploit.service';
import { clearDB, expectAnyAsyncError, getModuleRef } from '../utils';

describe('ExploitService', () => {
  let exploitService: ExploitService;
  let moduleRef: TestingModule;
  const exploitDtos: CreateExploitDto[] = [];
  for (let i = 0; i < 13; i++) {
    const letter = String.fromCharCode(97 + i);
    const exploitName = 'Open' + letter;
    const exploitDto: CreateExploitDto = {
      name: exploitName,
      author: 'Joe Deer',
      description: 'Lorem ipsum',
      script: '//script',
      targetAuthor: 'BlockChained',
      targetRepo: 'cool-contracts-upgradeable',
      targetPath: '/contracts/security',
      targetRef: '239r209i',
    };
    exploitDtos.push(exploitDto);
  }
  const searchExploitRequestDtoPage1 = {
    pageNo: 1,
    name: 'Op',
  };
  let exploit: Exploit;
  beforeEach(async () => {
    moduleRef = await getModuleRef();
    exploitService = moduleRef.get<ExploitService>(ExploitService);
    await clearDB();
    exploit = await exploitService.createExploit(exploitDtos[0]);
  });

  describe('createExploit', () => {
    it('Create a new Exploit', async () => {
      expect(exploit.name).to.equal(exploitDtos[0].name);
      expect(exploit.author).to.equal(exploitDtos[0].author);
      expect(exploit.description).to.equal(exploitDtos[0].description);
      expect(exploit.script).to.equal(exploitDtos[0].script);
    });

    it('Throw error when trying to create a repeat Exploit with exsiting name', async () => {
      await expectAnyAsyncError(exploitService.createExploit(exploitDtos[0]));
    });
  });

  describe('getExploit', () => {
    before(async () => {
      moduleRef = await getModuleRef();
      exploitService = moduleRef.get<ExploitService>(ExploitService);
      await clearDB();
    });

    it('Get an Exploit by id', async () => {
      const getExploit = await exploitService.getExploit(exploit.id);
      expect(exploit).to.eql(getExploit);
    });
  });

  describe('searchExploitByName', () => {
    it('Search Exploit by name in empty db', async () => {
      await clearDB();
      const dneExploits = await exploitService.searchExploitByName(
        searchExploitRequestDtoPage1
      );
      expect(dneExploits).to.eql([]);
    });
    it('Search Exploits by name on first page (pageNo=1)', async () => {
      const result = [];
      result.push(exploit);
      const pageNo = 1;
      assert(pageNo > 0);
      const exploitsOp = await exploitService.searchExploitByName(
        searchExploitRequestDtoPage1
      );
      expect(exploitsOp).to.eql(result);
    });
    it('Search Exploits by name is case sensitive', async () => {
      const searchExploitRequestDtoCaseSens = {
        pageNo: 1,
        name: 'o',
      };
      const result = [];
      const pageNo = 1;
      assert(pageNo > 0);
      const exploitsOp = await exploitService.searchExploitByName(
        searchExploitRequestDtoCaseSens
      );
      expect(exploitsOp).to.eql(result);
    });
    it('Search Exploit by non-exist name', async () => {
      const searchExploitRequestDtoDNEName = {
        pageNo: 1,
        name: 'hi',
      };
      const dneExploits = await exploitService.searchExploitByName(
        searchExploitRequestDtoDNEName
      );
      expect(dneExploits).to.eql([]);
    });
    it('Search Exploit by name on second page (pageNo=2)', async () => {
      const result = [];
      for (let i = 1; i < 12; i++) {
        await exploitService.createExploit(exploitDtos[i]);
      }
      result.push(await exploitService.createExploit(exploitDtos[12]));
      const searchExploitRequestDtoPage2 = {
        pageNo: 2,
        name: 'Op',
      };
      const exploitsOp = await exploitService.searchExploitByName(
        searchExploitRequestDtoPage2
      );
      expect(exploitsOp).to.eql(result);
    });
  });

  describe('verifyExploit', () => {
    it('Check verify of Exploit is false by default', async () => {
      expect(exploit.verify).to.be.false;
    });
    it('Update a Exploit to be Verified by id', async () => {
      await exploitService.verifyExploit(exploit.id);
      const getExploit = await exploitService.getExploit(exploit.id);
      expect(getExploit.verify).to.be.true;
    });
  });
});
